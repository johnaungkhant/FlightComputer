<!DOCTYPE html>
<html>

<head>
    <title>SetTarget</title>

    <meta charset="utf-8">
    <title>SetTarget</title>
    <meta http-equiv="Cache-control" content="no-cache">
    <meta http-equiv="Expires" content="-1">
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="application-name" content="SetTarget">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">

    <!-- <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="http://bbecquet.github.io/Leaflet.RotatedMarker/leaflet.rotatedMarker.js"></script> -->

    <link rel="stylesheet" href="map/leaflet/leaflet.css" />
    <script src="map/leaflet/leaflet.js"></script>
    <script src="map/leaflet.rotatedMarker.js"></script>

    <script src="lib/underscore.js"></script>
    <script src="lib/jquery-2.2.4.min.js"></script>

    <link href="lib/jquery.mobile/jquery.mobile-1.4.5.min.css" rel="stylesheet" />
    <script src="lib/jquery.mobile/jquery.mobile-1.4.5.min.js"></script>


    <script src="initConn.js"></script>

    <style>
        body {
            font-family: Courier, monospaced;
            font-size: 10px;
            font-weight: bold;

        }

        #eq>span {
            height: 120px;
            float: left;
            margin: 15px
        }

        textarea.ui-input-text {
            height: inherit !important
        }

        #map {
            height: 450px;
        }
    </style>
    <script>

        window.oncontextmenu = function (event) {
            event.preventDefault();
            event.stopPropagation();
            return false;
        };
    </script>
</head>

<body>
    <div id="map"></div>
    <div class="ui-field-contain">
        <fieldset class="ui-grid-a">
                <div class="ui-block-a"> <textarea name="" id="msg" style="width: 100%;" cols="30" rows="16"></textarea>
            </div>
                <div class="ui-block-b">

                <!-- <select name="flip-3" id="logdata" data-role="slider" data-mini="true">
                    <option value="off">Off</option>
                    <option value="on">On</option>
                </select> -->
                <button id="logdata">logdata</button>
            </div>
        </fieldset>
    </div>
    <script>

        $(function () {
            let lastWpDataStr = ''

            let status = false

            // showInfo()
            // magnification with which the map will start
            const zoom = 17;
            // co-ordinates
            const lat = 8.69713060
            const lng = 98.24120390

            // calling map

            // var bingmap = L.tileLayer("https://webstatic.github.io/static/bingmap/{z}/{x}/{y}.png", {
            //     maxZoom: 20,
            //     maxNativeZoom: 18
            // })
            var bingmapLocal = L.tileLayer("bingmap/{z}/{x}/{y}.png", {
                maxZoom: 20,
                maxNativeZoom: 17
            })

            var baseMaps = {
                "bingmapLocal": bingmapLocal,
            };

            let config = {
                minZoom: 7,
                maxZoom: 20,
                layers: [bingmapLocal]
            };
            const map = L.map("map", config).setView([lat, lng], zoom);

            L.control.layers(baseMaps).addTo(map);


            const funny = L.icon({
                iconUrl: "../map/Rust__Cesna206.svg",
                // iconSize: [50, 58], // size of the icon
                iconSize: [50, 50], // size of the icon
                //iconAnchor: [20, 58], // changed marker icon position
                iconAnchor: [25, 25], // changed marker icon position

                popupAnchor: [0, -60], // changed popup position
            });

            const funny2 = L.icon({
                iconUrl: "../map/Green-Up-Arrow.svg",
                // iconSize: [50, 58], // size of the icon
                iconSize: [50, 50], // size of the icon
                //iconAnchor: [20, 58], // changed marker icon position
                iconAnchor: [25, 25], // changed marker icon position

                popupAnchor: [0, -60], // changed popup position
            });

            const funny3 = L.icon({
                iconUrl: "../map/Red_Arrow_Up.svg",
                // iconSize: [50, 58], // size of the icon
                iconSize: [50, 50], // size of the icon
                //iconAnchor: [20, 58], // changed marker icon position
                iconAnchor: [25, 25], // changed marker icon position

                popupAnchor: [0, -60], // changed popup position
            });

            var pos = {
                lat: 8.69713060,
                lng: 98.24120390,
            }
            var rotationAngle = 0

            var marker = L.marker(pos, {
                icon: funny,
                rotationAngle: rotationAngle,
                rotationOrigin: 'center'
            }).addTo(map)

            var marker2 = L.marker(pos, {
                icon: funny2,
                rotationAngle: rotationAngle,
                rotationOrigin: 'center',
                opacity: 0.3
            }).addTo(map)

            var marker3 = L.marker(pos, {
                icon: funny3,
                rotationAngle: rotationAngle,
                rotationOrigin: 'center',
                opacity: 0.2
            }).addTo(map)
            // var marker0 = L.marker(pos, { opacity: 0.6 }).addTo(map).bindPopup("test");

            //var marker0 = L.circle(pos, 3).addTo(map);

            var lastLat = null
            var lastLon = null
            var D2R = Math.PI / 180;
            // Heading (N=0, E=90, S=189, W=270) from point 1 to point 2
            Heading = function (lat1, lon1, lat2, lon2) {

                var dlon = (lon2 - lon1) * D2R;

                lat1 = lat1 * D2R;
                lat2 = lat2 * D2R;

                var sdlon = Math.sin(dlon);
                var cdlon = Math.cos(dlon);

                var slat1 = Math.sin(lat1);
                var clat1 = Math.cos(lat1);

                var slat2 = Math.sin(lat2);
                var clat2 = Math.cos(lat2);

                var y = sdlon * clat2;
                var x = clat1 * slat2 - slat1 * clat2 * cdlon;

                var head = Math.atan2(y, x) * 180 / Math.PI;

                return (head + 360) % 360;
            };

            let getInfoLoop = function () {
                callGet('getInfo', null, function (result) {
                    console.log(result);
                    $('#msg').empty();
                    $('#msg').append("time: " + result.time + ' mem: ' + result.mem + '\n')
                    $('#msg').append("hdop: " + result.gps.hdop + ' satellites: ' + result.gps.satellites + '\n')


                    $('#msg').append("heading: " + result.sys.Heading + '\n')
                    $('#msg').append("alt: " + result.sys.alt + '\n')
                    $('#msg').append("altGps: " + result.gps.alt + ' speed: ' + result.gps.speed + '\n')

                    $('#msg').append('\n\n' + JSON.stringify(result))

                    // if (result.gps.gpsHeading) {
                    //     rotationAngle = result.gps.gpsHeading
                    // } else if (result.sys.Heading) {
                    if (result.estHeading != null) {
                        marker.setRotationAngle(result.estHeading)
                        marker.setOpacity(1)
                    } else {
                        marker.setOpacity(0.1)
                    }
                    //else {  

                    //}
                    // }

                    if (result.sys.Heading != null) {
                        marker3.setRotationAngle(result.sys.Heading)

                    }

                    //console.log('rotationAngle', rotationAngle);
                    if (result.gps.lat) {
                        pos.lat = result.gps.lat
                        pos.lng = result.gps.lon

                    }

                    marker.setLatLng(pos)
                    marker2.setLatLng(pos)
                    marker3.setLatLng(pos)

                    //marker0.bindPopup(JSON.stringify(pos));
                    //marker0.setLatLng(pos)
                    map.setView(pos)
                    //rotationAngle++
                    //if (currentSpeed && currentSpeed > 0) {


                    //if (result.gps.speed >= 1)
                    if (result.sys.HeadingUse) {
                        marker2.setRotationAngle(result.sys.HeadingUse)
                        marker2.setOpacity(0.3)
                    } else {
                        marker2.setOpacity(0.1)
                    }

                    // lastLat = result.lat
                    // lastLon = result.lon

                    setTimeout(() => {
                        getInfoLoop()
                    }, 500);
                })
            }

            callGet('getConfig', null, function (result) {
                console.log(result);
                getInfoLoop()
            })

        })

        function calEstHeading(comp0, gph0, comp1, gph1, comp) {
            //convert edge degree first
            let x0 = 0 //use as reference point
            let g0 = conAngle(gph0 - comp0)

            let x1 = conAngle(comp1 - comp0)
            let g1 = conAngle(gph1 - comp0)

            let y0 = conAngle(g0 - x0)
            let y1 = conAngle(g1 - x1)

            let xn = conAngle(comp - comp0)

            //console.log(x0, g0, x1, g1, y0, y1);
            let m = (y1 - y0) / conAngle(x1 - x0)
            //console.log(comp1, comp0, subAngle(comp1, comp0));
            console.log(y0, y1, m);
            // console.log((gph1 - comp1) - (gph0 - comp0), (comp1 - comp0), -3 / 10, m);
            let b = y0 - (m * x0)
            //console.log(b);

            let gn = (m * xn) + b + xn

            return conAngle(comp0 + gn)
        }

        function conAngle(result) {
            if (result > 180) {
                result = result - 360
            }
            if (result < -180) {
                result = result + 360
            }

            return result
        }

        //console.log(calEstHeading(10, 15, 20, 22, 18));
        //gph0, comp0, gph1, comp1, comp
        //console.log(calEstHeading(320, 285, 30, 350, 10));

    </script>

</body>

</html>